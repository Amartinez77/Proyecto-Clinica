name: CI/CD - Despliegue en Casa

on:
  push:
    branches: [ "main" ] # Se activa con cualquier push a 'main'

jobs:
  deploy:
    name: Despliegue a Host Local
    runs-on: self-hosted # ðŸ‘ˆ Ejecuta en el agente que acabas de configurar

    steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: Sincronizar y Desplegar Infraestructura
        run: |
          echo "ðŸš€ Iniciando despliegue automÃ¡tico..."
          
          cd /opt/Proyecto-Clinica/infra
          git reset --hard HEAD
          git pull origin main

          # Actualizar tambiÃ©n el cÃ³digo del Front y Back
          echo "ðŸ”„ Sincronizando SubmÃ³dulos..."
          cd .. # Subimos a la raÃ­z donde estÃ¡n los submÃ³dulos
          git submodule update --init --recursive
          cd infra # Volvemos a bajar a infra para ejecutar docker
          
          echo "ðŸ”„ Levantando TODO el stack (Infra + Apps) junto..."
          
          # COMANDO CORREGIDO: Cargamos ambos archivos a la vez (-f ... -f ...)
          # AsÃ­ Docker sabe que la DB y las Apps son amigos y no borra nada.
          docker compose -f docker-compose.mysql-cluster.yml -f docker-compose.yml up -d --build --remove-orphans

          echo "ðŸ§¹ Limpiando imÃ¡genes viejas..."
          docker image prune -f
          
          echo "âœ… Despliegue completado."